# USB æ‰‹æŸ„åŠŸèƒ½ - å®ç°æ€»ç»“

## âœ… å®ŒæˆçŠ¶æ€

ç¼–è¯‘æˆåŠŸï¼äºŒè¿›åˆ¶æ–‡ä»¶å·²ç”Ÿæˆï¼š
- è·¯å¾„: `target/riscv64gc-unknown-linux-musl/release/LinTx`
- å¤§å°: 2.1M
- æ–°å¢æ¨¡å—: `usb_gamepad`

---

## ğŸ“ æ–°å¢å’Œä¿®æ”¹çš„æ–‡ä»¶

### æ–°å¢æ–‡ä»¶

1. **`gamepad_composite.sh`** (å¯æ‰§è¡Œè„šæœ¬)
   - USB å¤åˆè®¾å¤‡é…ç½®è„šæœ¬
   - åŒæ—¶å¯ç”¨ RNDIS ç½‘ç»œï¼ˆSSHï¼‰+ HID æ‰‹æŸ„
   - ä¿ç•™åŸæœ‰ç½‘ç»œåŠŸèƒ½ï¼Œä¸ä¼šæ–­å¼€ SSH

2. **`src/usb_gamepad.rs`** (æ ¸å¿ƒæ¨¡å—)
   - ä» `mixer_out` æ¥æ”¶æ··æ§æ•°æ®
   - è½¬æ¢ä¸º HID æ¸¸æˆæ‰‹æŸ„æŠ¥å‘Šæ ¼å¼
   - å†™å…¥ `/dev/hidg0` è®¾å¤‡

3. **`test_usb_gamepad.sh`** (æµ‹è¯•è„šæœ¬)
   - ä¸€é”®å¯åŠ¨å®Œæ•´æµ‹è¯•æµç¨‹
   - ä½¿ç”¨ mock_joystick ç”Ÿæˆæµ‹è¯•æ•°æ®
   - è‡ªåŠ¨å¯åŠ¨æ‰€æœ‰å¿…éœ€æ¨¡å—

4. **`USB_GAMEPAD_GUIDE.md`** (è¯¦ç»†æ–‡æ¡£)
   - å®Œæ•´çš„ä½¿ç”¨æŒ‡å—
   - PC ç«¯æµ‹è¯•æ–¹æ³•ï¼ˆLinux/Windowsï¼‰
   - æ•…éšœæ’æŸ¥æ­¥éª¤

### ä¿®æ”¹æ–‡ä»¶

1. **`src/main.rs`**
   - æ·»åŠ  `mod usb_gamepad;` æ¨¡å—å£°æ˜

2. **`README.md`**
   - æ·»åŠ  `usb_gamepad` æ¨¡å—ä½¿ç”¨è¯´æ˜
   - æ›´æ–°é€šé“æ˜ å°„æ–‡æ¡£

---

## ğŸ”‘ æ ¸å¿ƒæ¦‚å¿µè§£ç­”

### Q: USB æ‰‹æŸ„å’Œ SSH èƒ½åŒæ—¶ä½¿ç”¨å—ï¼Ÿ

**A: å¯ä»¥ï¼å®Œå…¨ä¸å†²çªã€‚**

åŸç†ï¼š
- **USB Gadget å¤åˆè®¾å¤‡**ï¼šLinux æ”¯æŒä¸€ä¸ª USB è¿æ¥åŒæ—¶æä¾›å¤šä¸ªåŠŸèƒ½
- **RNDIS ç½‘ç»œåŠŸèƒ½**ï¼šç”¨äº SSH è¿æ¥ï¼ˆå·²æœ‰ï¼‰
- **HID æ‰‹æŸ„åŠŸèƒ½**ï¼šæ¨¡æ‹Ÿæ¸¸æˆæ‰‹æŸ„ï¼ˆæ–°å¢ï¼‰
- **å…±å­˜æœºåˆ¶**ï¼šä¸¤ä¸ªåŠŸèƒ½åœ¨åŒä¸€ä¸ª USB çº¿ä¸Šï¼Œäº’ä¸å¹²æ‰°

**æ— éœ€æ–­å¼€ SSHï¼Œæ— éœ€é‡Šæ”¾ USBï¼**

---

## ğŸš€ å¿«é€Ÿä½¿ç”¨

### åœ¨ä»æœºä¸Šè¿è¡Œ

```bash
# 0. ä¼ è¾“ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶åˆ°ä»æœºï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
scp target/riscv64gc-unknown-linux-musl/release/LinTx root@192.168.42.1:/root/

# 1. åœ¨ä»æœºä¸Šé…ç½® USB å¤åˆè®¾å¤‡
ssh root@192.168.42.1
cd /root
sh gamepad_composite.sh

# 2. ä¸€é”®æµ‹è¯•ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
sh test_usb_gamepad.sh

# æˆ–æ‰‹åŠ¨å¯åŠ¨å„æ¨¡å—
./LinTx --server &
./LinTx -- mock_joystick &
./LinTx -- mixer &
./LinTx -- usb_gamepad
```

### åœ¨ PC ä¸Šæµ‹è¯•

#### Linux PC
```bash
# æŸ¥çœ‹ USB è®¾å¤‡
lsusb  # åº”çœ‹åˆ° "Linux Foundation Multifunction Composite Gadget"

# æµ‹è¯•æ‰‹æŸ„
ls /dev/input/js*  # åº”çœ‹åˆ° /dev/input/js0
jstest /dev/input/js0

# SSH ä»ç„¶å¯ç”¨
ssh root@192.168.42.1
```

#### Windows PC
```bash
# æµ‹è¯•æ‰‹æŸ„
Win + R â†’ joy.cpl â†’ æŸ¥çœ‹ "LinTx GamePad"

# SSH ä»ç„¶å¯ç”¨ï¼ˆéœ€é…ç½®ç½‘ç»œï¼‰
# ç½‘ç»œæ¥å£ IP: 192.168.42.2
# è¿æ¥: ssh root@192.168.42.1
```

---

## ğŸ“Š æ•°æ®æµç¨‹

```
æ•°æ®æºé€‰æ‹©ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â€¢ STM32 ä¸²å£ (stm32_serial)             â”‚
â”‚ â€¢ CRSF æ¥æ”¶æœº (crsf_rc_in)              â”‚
â”‚ â€¢ Mock æ•°æ® (mock_joystick)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚ AdcRawMsg
               â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Mixer   â”‚ (æ··æ§å™¨)
         â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
               â”‚ MixerOutMsg (4 fields)
               â”‚ â€¢ thrust (æ²¹é—¨): 0~10000
               â”‚ â€¢ direction (æ–¹å‘): 0~10000
               â”‚ â€¢ aileron (å‰¯ç¿¼): 0~10000
               â”‚ â€¢ elevator (å‡é™): 0~10000
               â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  usb_gamepad     â”‚ (æ–°æ¨¡å—)
    â”‚  â€¢ è½¬æ¢å€¼åŸŸ       â”‚
    â”‚  â€¢ ç”ŸæˆHIDæŠ¥å‘Š    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚ HID Report (5 bytes)
             â”‚ [buttons, X, Y, Z, Rz]
             â”‚ å€¼åŸŸ: -127~127
             â†“
       /dev/hidg0
             â”‚ USB ä¼ è¾“
             â†“
      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚   PC ç«¯    â”‚
      â”‚  è¯†åˆ«ä¸ºæ‰‹æŸ„ â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ® HID æŠ¥å‘Šæ ¼å¼

### æŠ¥å‘Šç»“æ„ (5 bytes)

| Byte | æè¿° | å€¼åŸŸ | å½“å‰ä½¿ç”¨ |
|------|------|------|---------|
| 0 | æŒ‰é”®çŠ¶æ€ (8ä¸ªbit) | 0x00-0xFF | å›ºå®šä¸º 0 (æš‚æ— æŒ‰é”®) |
| 1 | X è½´ (Direction) | -127~127 | âœ… direction æ˜ å°„ |
| 2 | Y è½´ (Elevator) | -127~127 | âœ… elevator æ˜ å°„ |
| 3 | Z è½´ (Aileron) | -127~127 | âœ… aileron æ˜ å°„ |
| 4 | Rz è½´ (Thrust) | -127~127 | âœ… thrust æ˜ å°„ |

### å€¼è½¬æ¢å…¬å¼

```rust
// Mixer è¾“å‡º: 0 ~ 10000, ä¸­å¿ƒå€¼ 5000
// HID è¾“å‡º: -127 ~ 127, ä¸­å¿ƒå€¼ 0

fn mixer_to_hid_axis(mixer_value: u16) -> i8 {
    let normalized = (mixer_value as i32 - 5000) as f32 / 5000.0; // -1.0 ~ +1.0
    let hid_value = (normalized * 127.0) as i32;
    hid_value.clamp(-127, 127) as i8
}
```

### é€šé“æ˜ å°„

| Mixer å­—æ®µ | åŠŸèƒ½ | HID è½´ | Mixer å€¼åŸŸ | HID å€¼åŸŸ |
|-----------|------|--------|-----------|---------|
| direction | æ–¹å‘ï¼ˆå·¦å³ï¼‰ | X è½´ | 0~10000 | -127~127 |
| elevator | å‡é™ | Y è½´ | 0~10000 | -127~127 |
| aileron | å‰¯ç¿¼ | Z è½´ | 0~10000 | -127~127 |
| thrust | æ²¹é—¨ | Rz è½´ | 0~10000 | -127~127 |

---

## ğŸ› ï¸ æ•…éšœæ’æŸ¥

### é—®é¢˜1: ç¼–è¯‘è­¦å‘Š

**ç°è±¡**: 16 ä¸ªè­¦å‘Š
**å½±å“**: æ— å½±å“ï¼Œä»…æç¤ºæœªä½¿ç”¨çš„å˜é‡å’Œå¯¼å…¥
**æ“ä½œ**: å¯ä»¥å¿½ç•¥ï¼Œæˆ–è¿è¡Œ `cargo fix --bin "LinTx"` æ¸…ç†

### é—®é¢˜2: `/dev/hidg0` ä¸å­˜åœ¨

**æ£€æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥ configfs æ˜¯å¦æŒ‚è½½
mount | grep configfs

# 2. é‡æ–°è¿è¡Œé…ç½®è„šæœ¬
sh gamepad_composite.sh

# 3. éªŒè¯è®¾å¤‡åˆ›å»º
ls -l /dev/hidg0
```

### é—®é¢˜3: PC ç«¯çœ‹ä¸åˆ°æ‰‹æŸ„

**æ£€æŸ¥æ­¥éª¤**:
```bash
# åœ¨ä»æœºä¸Š
cat /sys/class/udc/*/state  # åº”æ˜¾ç¤º "configured"

# åœ¨ PC ä¸Šï¼ˆLinuxï¼‰
lsusb | grep -i gadget
dmesg | tail -20

# åœ¨ PC ä¸Šï¼ˆWindowsï¼‰
# è®¾å¤‡ç®¡ç†å™¨ â†’ äººä½“å­¦è¾“å…¥è®¾å¤‡ â†’ åº”çœ‹åˆ°æ‰‹æŸ„
```

### é—®é¢˜4: SSH æ–­å¼€

**åŸå› **: å¯èƒ½è¿è¡Œäº†æ—§çš„ `gamepad.sh`ï¼ˆåªæœ‰ HIDï¼Œæ²¡æœ‰ç½‘ç»œï¼‰
**è§£å†³**: ä½¿ç”¨æ–°çš„ `gamepad_composite.sh`

---

## ğŸ”® æœªæ¥æ‰©å±•

### æ·»åŠ æŒ‰é”®æ”¯æŒ

å¦‚æœ mixer æœªæ¥æ”¯æŒæŒ‰é”®è¾“å‡ºï¼Œå¯ä»¥ä¿®æ”¹ `src/usb_gamepad.rs`:

```rust
// ç¤ºä¾‹ï¼šä» mixer è·å– 8 ä¸ªæŒ‰é”®çŠ¶æ€
for i in 0..8 {
    if some_button_state[i] {
        report.buttons |= 1 << i;
    }
}
```

### å¢åŠ æ›´å¤šè½´

ä¿®æ”¹ `gamepad_composite.sh` ä¸­çš„ HID Report Descriptorï¼Œå¯ä»¥æ”¯æŒï¼š
- 6 è½´æ‰‹æŸ„ï¼ˆæ·»åŠ  Rx, Ry è½´ï¼‰
- POV Hat Switchï¼ˆæ–¹å‘é”®ï¼‰
- å¤šè¾¾ 32 ä¸ªæŒ‰é”®

---

## ğŸ“š å‚è€ƒæ–‡æ¡£

- USB HID ä½¿ç”¨æ‰‹å†Œ: https://www.usb.org/hid
- Linux USB Gadget API: https://www.kernel.org/doc/html/latest/usb/gadget.html
- `USB_GAMEPAD_GUIDE.md` (æœ¬é¡¹ç›®è¯¦ç»†æ–‡æ¡£)

---

## âœ… éªŒæ”¶æ¸…å•

- [x] ç¼–è¯‘æˆåŠŸï¼ˆ2.1M äºŒè¿›åˆ¶ï¼‰
- [x] USB å¤åˆè®¾å¤‡é…ç½®è„šæœ¬åˆ›å»º
- [x] `usb_gamepad` æ¨¡å—å®ç°
- [x] æ•°æ®æµ: mock â†’ mixer â†’ usb_gamepad â†’ /dev/hidg0
- [x] å€¼åŸŸè½¬æ¢: 0~10000 â†’ -127~127
- [x] SSH å’Œæ‰‹æŸ„å…±å­˜æ”¯æŒ
- [x] æ–‡æ¡£æ›´æ–°ï¼ˆREADME + ä½¿ç”¨æŒ‡å—ï¼‰
- [x] æµ‹è¯•è„šæœ¬åˆ›å»º

**çŠ¶æ€**: ğŸ‰ å…¨éƒ¨å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•ï¼

---

## ä¸‹ä¸€æ­¥

1. **ä¼ è¾“åˆ°ä»æœº**
   ```bash
   scp target/riscv64gc-unknown-linux-musl/release/LinTx root@192.168.42.1:/root/
   scp gamepad_composite.sh test_usb_gamepad.sh root@192.168.42.1:/root/
   ```

2. **åœ¨ä»æœºä¸Šæµ‹è¯•**
   ```bash
   ssh root@192.168.42.1
   sh test_usb_gamepad.sh
   ```

3. **åœ¨ PC ä¸ŠéªŒè¯**
   - æ£€æŸ¥ç½‘ç»œæ¥å£ï¼ˆSSH ä»å¯ç”¨ï¼‰
   - æ£€æŸ¥æ‰‹æŸ„è®¾å¤‡ï¼ˆjstest æˆ– joy.cplï¼‰
   - è§‚å¯Ÿæ‘‡æ†æ•°æ®å˜åŒ–

ç¥ä½ æµ‹è¯•é¡ºåˆ©ï¼ğŸ®
