# USB æ‰‹æŸ„åŠŸèƒ½ä½¿ç”¨æŒ‡å—

## é—®é¢˜è§£ç­”

### Q: æˆ‘ç°åœ¨ç”¨USBåšSSHï¼Œèƒ½åŒæ—¶è·‘USBæ‰‹æŸ„å—ï¼Ÿ
**A: å¯ä»¥ï¼ä¸éœ€è¦æ–­å¼€SSHã€‚**

Linux USB Gadget æ”¯æŒ**å¤åˆè®¾å¤‡**ï¼ˆComposite Deviceï¼‰ï¼Œå¯ä»¥åŒæ—¶æä¾›å¤šä¸ªåŠŸèƒ½ï¼š
- USB ç½‘ç»œåŠŸèƒ½ï¼ˆRNDIS/ECMï¼‰â†’ ç”¨äº SSH
- USB HID æ‰‹æŸ„åŠŸèƒ½ â†’ æ¨¡æ‹Ÿæ¸¸æˆæ‰‹æŸ„

ä¸¤è€…äº’ä¸å¹²æ‰°ï¼Œåœ¨åŒä¸€ä¸ªUSBè¿æ¥ä¸Šå…±å­˜ã€‚

---

## ä½¿ç”¨æ­¥éª¤

### æ–¹æ³•1: å¿«é€Ÿæµ‹è¯•ï¼ˆæ¨èæ–°æ‰‹ï¼‰

```bash
# ä¸€é”®å¯åŠ¨æµ‹è¯•ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
sh test_usb_gamepad.sh
```

è¿™ä¸ªè„šæœ¬ä¼šè‡ªåŠ¨ï¼š
1. é…ç½® USB å¤åˆè®¾å¤‡ï¼ˆç½‘ç»œ + æ‰‹æŸ„ï¼‰
2. å¯åŠ¨ LinTx æœåŠ¡å™¨
3. å¯åŠ¨ mock_joystick ç”Ÿæˆæ­£å¼¦æ³¢æµ‹è¯•æ•°æ®
4. å¯åŠ¨ mixer å’Œ usb_gamepad æ¨¡å—

### æ–¹æ³•2: æ‰‹åŠ¨é€æ­¥é…ç½®

#### ç¬¬1æ­¥ï¼šé…ç½®USBå¤åˆè®¾å¤‡

```bash
# è¿è¡Œå¤åˆè®¾å¤‡é…ç½®è„šæœ¬
sh gamepad_composite.sh
```

**è¿™ä¸ªè„šæœ¬åšäº†ä»€ä¹ˆï¼Ÿ**
- ä¿ç•™åŸæœ‰çš„ RNDIS ç½‘ç»œåŠŸèƒ½ï¼ˆSSH ç»§ç»­å¯ç”¨ï¼‰
- æ–°å¢ HID æ‰‹æŸ„åŠŸèƒ½
- åˆ›å»º `/dev/hidg0` è®¾å¤‡èŠ‚ç‚¹

**æ£€æŸ¥æ˜¯å¦æˆåŠŸï¼š**
```bash
ls -l /dev/hidg0
# åº”è¯¥è¾“å‡ºç±»ä¼¼: crw------- 1 root root 243, 0 Jan  4 10:30 /dev/hidg0

ifconfig usb0
# åº”è¯¥çœ‹åˆ° usb0 ç½‘å¡ï¼ŒIP 192.168.42.1
```

#### ç¬¬2æ­¥ï¼šå¯åŠ¨ LinTx æ¨¡å—

```bash
# å¯åŠ¨æœåŠ¡å™¨
./LinTx --server &

# é€‰æ‹©æ•°æ®æºä¹‹ä¸€ï¼š

# é€‰é¡¹A: ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆæµ‹è¯•ç”¨ï¼‰
./LinTx -- mock_joystick --config mock_config.toml &

# é€‰é¡¹B: ä½¿ç”¨ STM32 ä¸²å£æ•°æ®
./LinTx -- stm32_serial /dev/ttyS0 --baudrate 115200 &

# é€‰é¡¹C: ä½¿ç”¨ CRSF æ¥æ”¶æœºæ•°æ®
./LinTx -- crsf_rc_in /dev/ttyS0 &

# å¯åŠ¨æ··æ§å™¨
./LinTx -- mixer &

# å¯åŠ¨ USB æ‰‹æŸ„è¾“å‡º
./LinTx -- usb_gamepad
```

---

## åœ¨ PC ç«¯æµ‹è¯•

### Linux PC æµ‹è¯•

1. **è¿æ¥ USB çº¿**
   ```bash
   # PC ç«¯åº”è¯¥çœ‹åˆ°ä¸¤ä¸ªè®¾å¤‡ï¼š
   # 1. ç½‘ç»œè®¾å¤‡ï¼ˆusb0 æˆ– eth1 ç­‰ï¼‰
   lsusb  # æŸ¥çœ‹ USB è®¾å¤‡åˆ—è¡¨
   
   # 2. æ¸¸æˆæ‰‹æŸ„è®¾å¤‡
   ls /dev/input/js*  # åº”è¯¥çœ‹åˆ° /dev/input/js0
   ```

2. **é…ç½®ç½‘ç»œï¼ˆä¿æŒ SSHï¼‰**
   ```bash
   # æ‰¾åˆ° USB ç½‘å¡åç§°
   ip link | grep -i usb
   
   # é…ç½® PC ç«¯ IP
   sudo ip addr add 192.168.42.2/24 dev <ç½‘å¡å>
   sudo ip link set <ç½‘å¡å> up
   
   # æµ‹è¯• SSH è¿æ¥
   ssh root@192.168.42.1
   ```

3. **æµ‹è¯•æ‰‹æŸ„**
   ```bash
   # å®‰è£…æµ‹è¯•å·¥å…·
   sudo apt install joystick
   
   # æµ‹è¯•æ‰‹æŸ„è¾“å…¥
   jstest /dev/input/js0
   
   # ä½ åº”è¯¥çœ‹åˆ°4ä¸ªæ‘‡æ†è½´å’Œ8ä¸ªæŒ‰é”®çš„å®æ—¶æ•°æ®
   ```

### Windows PC æµ‹è¯•

1. **é©±åŠ¨å®‰è£…**
   - Windows 10/11 ä¼šè‡ªåŠ¨è¯†åˆ« USB HID æ‰‹æŸ„ï¼Œæ— éœ€é¢å¤–é©±åŠ¨
   - ç½‘ç»œåŠŸèƒ½å¯èƒ½éœ€è¦å®‰è£… RNDIS é©±åŠ¨

2. **æµ‹è¯•æ‰‹æŸ„**
   - æŒ‰ `Win + R`ï¼Œè¾“å…¥ `joy.cpl`ï¼Œæ‰“å¼€"æ¸¸æˆæ§åˆ¶å™¨"
   - åº”è¯¥èƒ½çœ‹åˆ° "LinTx GamePad"
   - ç‚¹å‡»"å±æ€§"å¯ä»¥æµ‹è¯•æ‘‡æ†å’ŒæŒ‰é”®

3. **é…ç½®ç½‘ç»œï¼ˆSSHï¼‰**
   - æ‰“å¼€"ç½‘ç»œè¿æ¥"ï¼Œæ‰¾åˆ°æ–°å‡ºç°çš„ USB ç½‘å¡
   - é…ç½®é™æ€ IPï¼š`192.168.42.2`ï¼Œå­ç½‘æ©ç  `255.255.255.0`
   - ä½¿ç”¨ PuTTY æˆ– WSL è¿æ¥ï¼š`ssh root@192.168.42.1`

---

## é€šé“æ˜ å°„è¯´æ˜

### Mixer è¾“å‡º â†’ USB HID æ˜ å°„

| Mixer é€šé“ | åŠŸèƒ½ | HID æ˜ å°„ | å€¼åŸŸ |
|-----------|------|---------|------|
| channels[0] | Throttle (æ²¹é—¨) | Rzè½´ | -127 ~ 127 |
| channels[1] | Aileron (å‰¯ç¿¼) | Xè½´ | -127 ~ 127 |
| channels[2] | Elevator (å‡é™) | Yè½´ | -127 ~ 127 |
| channels[3] | Rudder (æ–¹å‘èˆµ) | Zè½´ | -127 ~ 127 |
| channels[4] | Aux1 | æŒ‰é”®1 | 0/1 |
| channels[5] | Aux2 | æŒ‰é”®2 | 0/1 |
| ... | ... | ... | ... |
| channels[11] | Aux8 | æŒ‰é”®8 | 0/1 |

**å€¼è½¬æ¢è§„åˆ™ï¼š**
- CRSF å€¼åŸŸ: 0 ~ 1984 (ä¸­å¿ƒå€¼ 992)
- HID è½´å€¼åŸŸ: -127 ~ 127 (ä¸­å¿ƒå€¼ 0)
- æŒ‰é”®åˆ¤æ–­: CRSF > 992 ä¸ºæŒ‰ä¸‹

---

## æ•…éšœæ’æŸ¥

### é—®é¢˜1: `/dev/hidg0` ä¸å­˜åœ¨

**è§£å†³æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥ configfs æ˜¯å¦æŒ‚è½½
mount | grep configfs

# å¦‚æœæ²¡æœ‰ï¼Œæ‰‹åŠ¨æŒ‚è½½
mount none /configs -t configfs

# é‡æ–°è¿è¡Œé…ç½®è„šæœ¬
sh gamepad_composite.sh
```

### é—®é¢˜2: SSH æ–­å¼€äº†

**åŸå› ï¼š** æ—§çš„ `gamepad.sh` åªé…ç½®äº† HIDï¼Œæ²¡æœ‰ä¿ç•™ç½‘ç»œåŠŸèƒ½ã€‚

**è§£å†³æ–¹æ³•ï¼š** ä½¿ç”¨æ–°çš„ `gamepad_composite.sh` è„šæœ¬ï¼Œå®ƒåŒæ—¶ä¿ç•™ç½‘ç»œå’Œæ‰‹æŸ„ã€‚

### é—®é¢˜3: PC ç«¯çœ‹ä¸åˆ°æ‰‹æŸ„

**æ£€æŸ¥æ­¥éª¤ï¼š**
```bash
# åœ¨ä»æœºä¸Šæ£€æŸ¥
lsusb  # åº”è¯¥çœ‹ä¸åˆ°è®¾å¤‡ï¼ˆå› ä¸ºæ˜¯ Device æ¨¡å¼ï¼‰
cat /sys/class/udc/*/state  # åº”è¯¥æ˜¾ç¤º "configured"

# åœ¨ PC ä¸Šæ£€æŸ¥
lsusb  # åº”è¯¥çœ‹åˆ° "Linux Foundation Multifunction Composite Gadget"
dmesg | tail -20  # æŸ¥çœ‹ USB è¯†åˆ«æ—¥å¿—
```

### é—®é¢˜4: ç¼–è¯‘æ–°æ¨¡å—å¤±è´¥

**æ“ä½œï¼š**
```bash
# æ¸…ç†å¹¶é‡æ–°ç¼–è¯‘
cd /home/shimmer/LinTx/LinTx_musl
cargo clean
cross build --target riscv64gc-unknown-linux-musl --release

# ä¼ è¾“åˆ°ä»æœº
scp target/riscv64gc-unknown-linux-musl/release/LinTx root@192.168.42.1:/root/
```

---

## é«˜çº§ç”¨æ³•

### è‡ªå®šä¹‰é€šé“æ˜ å°„

ç¼–è¾‘ `src/usb_gamepad.rs` ä¸­çš„æ˜ å°„é€»è¾‘ï¼š

```rust
// ä¾‹å¦‚ï¼šå°† Throttle æ˜ å°„åˆ° Yè½´
report.axis_y = crsf_to_hid_axis(msg.channels[0]);  // Throttle
report.axis_x = crsf_to_hid_axis(msg.channels[1]);  // Aileron
// ...
```

### ä¿®æ”¹ HID æŠ¥å‘Šæè¿°ç¬¦

ç¼–è¾‘ `gamepad_composite.sh` ä¸­çš„ Report Descriptorï¼Œå¯ä»¥ï¼š
- å¢åŠ æ›´å¤šæŒ‰é”®ï¼ˆæœ€å¤š32ä¸ªï¼‰
- æ·»åŠ æ›´å¤šæ‘‡æ†è½´ï¼ˆ6è½´ã€8è½´ç­‰ï¼‰
- æ·»åŠ  POV Hat Switchï¼ˆæ–¹å‘é”®ï¼‰

å‚è€ƒï¼š[USB HID ä½¿ç”¨æ‰‹å†Œ](https://www.usb.org/document-library/device-class-definition-hid-111)

---

## æ€»ç»“

âœ… **USBç½‘ç»œå’ŒUSBæ‰‹æŸ„å¯ä»¥åŒæ—¶ä½¿ç”¨**  
âœ… **SSHä¸ä¼šæ–­å¼€ï¼Œæ•°æ®ä¼ è¾“äº’ä¸å¹²æ‰°**  
âœ… **ä¸€ä¸ªUSBçº¿ç¼†ï¼Œä¸¤ç§åŠŸèƒ½**

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼ğŸ®
